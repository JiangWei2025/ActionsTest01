# ワークフロー名
name: Branch01 CI/CD Workflow

# トリガー設定：branch01へのpush時に実行
on:
  push:
    branches:
      - branch01

jobs:
  build-and-test:
    # Ubuntu最新版で実行
    runs-on: ubuntu-latest
    
    steps:
      # branch01のコードをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # チェックアウトするブランチを指定
          ref: branch01
          # 最新のコミットのみ取得（浅いクローン）
          fetch-depth: 1
      
      # ファイルの整合性チェック
      - name: Check file integrity
        run: bash scripts/check_integrity.sh
      
      # Python環境のセットアップ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # Pythonバージョン（最新の3.x系）
          python-version: '3.x'
      
      # テストの実行
      - name: Run tests
        run: |
          python tests/test_main.py
      
      # プルリクエストの作成
      - name: Create Pull Request
        env:
          # GitHub CLIで使用するトークン
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 既存のPRをチェック branch01からmainへのPR
          existing_pr=$(gh pr list --head branch01 --base main --json number --jq '.[0].number')
          
          # PRが存在しない場合のみ作成
          if [ -z "$existing_pr" ]; then
            # 新しいPRを作成
            gh pr create \
              --title "Auto PR from branch01" \
              --body "This is an automated pull request created from branch01.

            - ✅ File integrity checks passed
            - ✅ Tests executed successfully" \
              --base main \
              --head branch01
            echo "PR created successfully"
          else
            # 既にPRが存在する場合はスキップ
            echo "PR already exists: #$existing_pr"
          fi
